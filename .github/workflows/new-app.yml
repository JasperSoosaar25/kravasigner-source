name: New App Notification

on:
  push:
    branches: [ main ]  # Change if your default branch is different
    paths:
      - '**/*.ipa'

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Find new IPA files
        id: find_ipa
        run: |
          git fetch --all
          NEW_IPAS=$(git diff --name-only HEAD~1 HEAD | grep '\.ipa$' || echo "")
          echo "new_ipas=$NEW_IPAS" >> $GITHUB_OUTPUT

      - name: Setup Python
        if: steps.find_ipa.outputs.new_ipas != ''
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        if: steps.find_ipa.outputs.new_ipas != ''
        run: pip install requests biplist

      - name: Process and notify
        if: steps.find_ipa.outputs.new_ipas != ''
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          REPO: ${{ github.repository }}
        run: |-
          python - << 'EOF'
          import requests
          import zipfile
          import biplist
          import os

          new_ipas = "${{ steps.find_ipa.outputs.new_ipas }}".split()
          raw_base = f"https://raw.githubusercontent.com/{os.environ['REPO']}/{os.environ['GITHUB_SHA']}"

          for ipa_path in new_ipas:
              ipa_url = f"{raw_base}/{ipa_path}"
              ipa_data = requests.get(ipa_url).content
              with open("temp.ipa", "wb") as f:
                  f.write(ipa_data)
              
              with zipfile.ZipFile("temp.ipa") as z:
                  plist_found = False
                  for name in z.namelist():
                      if name.endswith("/Info.plist") and "Payload/" in name:
                          plist_data = z.read(name)
                          info = biplist.readPlistFromString(plist_data)
                          app_name = info.get('CFBundleDisplayName') or info.get('CFBundleName') or 'Unknown'
                          bundle_id = info.get('CFBundleIdentifier', 'Unknown')
                          version = info.get('CFBundleShortVersionString') or info.get('CFBundleVersion', 'Unknown')
                          plist_found = True
                          break
                  if not plist_found:
                      app_name = bundle_id = version = 'Unknown (Invalid IPA)'
              
              # App Store lookup
              lookup = requests.get(f"https://itunes.apple.com/lookup?bundleId={bundle_id}").json()
              if lookup.get('resultCount', 0) > 0:
                  app = lookup['results'][0]
                  developer = app.get('artistName', 'N/A')
                  genres = app.get('genres', [])
                  subtitle = app.get('subtitle', genres[0] if genres else 'N/A')
                  description = app.get('description', 'N/A')
                  app_id = app['trackId']
                  link = app['trackViewUrl']
              else:
                  developer = subtitle = description = app_id = 'N/A (Not on App Store)'
                  link = ipa_url
              
              message = """ðŸ†• **New App Added to KravaSigner!**

**Name:** %s
**Bundle ID:** %s
**Version:** %s
**Developer:** %s
**Subtitle:** %s
**Description:** %s... (truncated if long)
**App Store ID:** %s
**Download/Link:** %s""" % (app_name, bundle_id, version, developer, subtitle, description[:800], app_id, link)
              
              requests.post(
                  f"https://api.telegram.org/bot{os.environ['TELEGRAM_TOKEN']}/sendMessage",
                  data={
                      'chat_id': os.environ['TELEGRAM_CHAT_ID'],
                      'text': message.strip(),
                      'parse_mode': 'Markdown',
                      'disable_web_page_preview': 'true'
                  }
              )
              
              if os.path.exists("temp.ipa"):
                  os.remove("temp.ipa")
          EOF
