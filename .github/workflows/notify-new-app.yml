name: Notify Telegram on New App

on:
  push:
    branches: [ main ]
    paths:
      - 'My KravaSigner Source_3.json'

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect new apps and send to Telegram
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          sudo apt-get update && sudo apt-get install -y jq

          # Previous commit
          git checkout HEAD~1 -- "My KravaSigner Source_3.json" 2>/dev/null || echo "No previous"
          if [ -f "My KravaSigner Source_3.json" ]; then cp "My KravaSigner Source_3.json" old.json; else touch old.json; fi

          # Current
          git checkout HEAD -- "My KravaSigner Source_3.json"
          cp "My KravaSigner Source_3.json" new.json

          jq '.apps // []' old.json > old_apps.json
          jq '.apps // []' new.json > new_apps.json

          comm -23 <(jq -r '.[].name // empty' new_apps.json | sort) <(jq -r '.[].name // empty' old_apps.json | sort) > new_app_names.txt

          if [ ! -s new_app_names.txt ]; then
            echo "No new apps detected"
            exit 0
          fi

          REPO_URL="https://raw.githubusercontent.com/JasperSoosaar25/kravasigner-source/main/My%20KravaSigner%20Source_3.json"

          while read APP_NAME; do
            [ -z "$APP_NAME" ] && continue

            APP=$(jq -r --arg name "$APP_NAME" '.apps[] | select(.name == $name)' new.json)

            TITLE=$(echo "$APP" | jq -r '.name')
            SUBTITLE=$(echo "$APP" | jq -r '.subtitle // "No description"')
            DEVELOPER=$(echo "$APP" | jq -r '.developerName')
            VERSION=$(echo "$APP" | jq -r '.versions[0].version // "Unknown"')
            ICON_URL=$(echo "$APP" | jq -r '.iconURL')
            MARKETPLACE_ID=$(echo "$APP" | jq -r '.marketplaceID // ""')
            APPSTORE_LINK="https://apps.apple.com/us/app/id$MARKETPLACE_ID"
            [ "$MARKETPLACE_ID" = "" ] && APPSTORE_LINK="No App Store link"

            CAPTION="üêÆ *New tweaked/modded IPA available!* üöÄ\n\n"
            CAPTION="${CAPTION}*$TITLE*\n"
            CAPTION="${CAPTION}$SUBTITLE\n"
            CAPTION="${CAPTION}$DEVELOPER\n"
            CAPTION="${CAPTION}Version: $VERSION\n"
            CAPTION="${CAPTION}*Repository:*\n$REPO_URL\n"
            CAPTION="${CAPTION}*App Store Link:*\n$APPSTORE_LINK"

            # Send photo (icon) with caption
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendPhoto" \
              -d chat_id="$TELEGRAM_CHAT_ID" \
              -d photo="$ICON_URL" \
              -d caption="$CAPTION" \
              -d parse_mode=Markdown \
              -d disable_web_page_preview=true

            sleep 1  # Avoid rate limits
          done < new_app_names.txt

          echo "All notifications with icons sent!"
