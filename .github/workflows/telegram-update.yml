name: Telegram app updates

on:
  push:
    paths:
      - "**/*.json"

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Send Telegram updates
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          REPO_URL: ${{ secrets.REPO_URL }}
        run: >
          python3 -c "import json,subprocess,html,os,sys;
          BOT=os.environ.get('TELEGRAM_BOT_TOKEN');
          CHAT=os.environ.get('TELEGRAM_CHAT_ID');
          REPO=os.environ.get('REPO_URL','');
          file=subprocess.check_output(['bash','-lc','git diff --name-only HEAD^ HEAD | grep \\.json$ | head -n 1'],text=True).strip();
          cur=json.load(open(file));
          try: prev=json.loads(subprocess.check_output(['bash','-lc',f'git show HEAD^:{file}'],text=True));
          except: prev={'apps':[]};
          cur_apps={a['bundleIdentifier']:a for a in cur.get('apps',[])};
          prev_apps={a['bundleIdentifier']:a for a in prev.get('apps',[])};
          new=[cur_apps[b] for b in cur_apps if b not in prev_apps];
          esc=lambda s: html.escape(str(s),quote=False);
          import subprocess as sp;
          for a in new:
            v=max(a.get('versions',[]),key=lambda x:x.get('date',''),default={});
            msg=f'ğŸš€ <b>New App Added!</b>\\n\\nğŸ“± <b>App:</b> {esc(a.get(\"name\"))}\\nğŸ†” <b>Bundle:</b> <code>{esc(a.get(\"bundleIdentifier\"))}</code>\\nğŸ‘¨â€ğŸ’» <b>Developer:</b> {esc(a.get(\"developerName\"))}\\nğŸ§© <b>Version:</b> {esc(v.get(\"version\",\"N/A\"))}\\n\\nğŸ“ <b>Description:</b>\\n{esc(a.get(\"localizedDescription\") or a.get(\"subtitle\") or \"\")}\\n\\nğŸ <b>App Store:</b> https://apps.apple.com/app/id{a.get(\"marketplaceID\")}\\nğŸ“¦ <b>Repo:</b> {esc(REPO)}';
            sp.run(['curl','-s','-X','POST',f'https://api.telegram.org/bot{BOT}/sendMessage','-d',f'chat_id={CHAT}','-d','parse_mode=HTML','-d','disable_web_page_preview=true','-d',f'text={msg}'])"
