name: Telegram app updates

on:
  push:
    paths:
      - "**/*.json"

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (with previous commit)
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Send Telegram messages for new apps
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          REPO_URL: ${{ secrets.REPO_URL }}
        run: |
          python3 - << 'PY'
          import json, subprocess, html, os, sys
          from datetime import datetime

          BOT = os.environ["TELEGRAM_BOT_TOKEN"]
          CHAT = os.environ["TELEGRAM_CHAT_ID"]
          REPO_URL = os.environ.get("REPO_URL", "")

          # find changed json file
          try:
            file = subprocess.check_output(
              ["bash", "-lc", "git diff --name-only HEAD^ HEAD | grep -E '\\.json$' | head -n 1"],
              text=True
            ).strip()
          except subprocess.CalledProcessError:
            sys.exit(0)

          if not file:
            sys.exit(0)

          def load_current():
            with open(file, "r", encoding="utf-8") as f:
              return json.load(f)

          def load_previous():
            try:
              out = subprocess.check_output(
                ["bash", "-lc", f"git show HEAD^:{file}"], text=True
              )
              return json.loads(out)
            except Exception:
              return {"apps": []}

          cur = load_current()
          prev = load_previous()

          cur_apps = {a["bundleIdentifier"]: a for a in cur.get("apps", [])}
          prev_apps = {a["bundleIdentifier"]: a for a in prev.get("apps", [])}

          new_bundles = [b for b in cur_apps if b not in prev_apps]

          if not new_bundles:
            sys.exit(0)

          def latest_version(app):
            versions = app.get("versions", [])
            if not versions:
              return {}
            return max(
              versions,
              key=lambda v: v.get("date", "")
            )

          def esc(s):
            return html.escape(str(s), quote=False)

          for bid in new_bundles:
            app = cur_apps[bid]
            ver = latest_version(app)

            name = app.get("name", "Unknown")
            dev = app.get("developerName", "Unknown developer")
            desc = app.get("localizedDescription") or app.get("subtitle") or ""
            version = ver.get("version", "")
            mid = str(app.get("marketplaceID", "")).strip()
            appstore = f"https://apps.apple.com/app/id{mid}" if mid else "N/A"

            if len(desc) > 800:
              desc = desc[:800].rstrip() + "â€¦"

            message = f"""
ğŸš€ <b>New App Added to KravaSigner!</b>

ğŸ“± <b>App name:</b> {esc(name)}
ğŸ†” <b>Bundle ID:</b> <code>{esc(bid)}</code>
ğŸ‘¨â€ğŸ’» <b>Developer:</b> {esc(dev)}
ğŸ§© <b>Version:</b> {esc(version)}

ğŸ“ <b>Description:</b>
{esc(desc)}

ğŸ <b>App Store:</b>
{esc(appstore)}

ğŸ“¦ <b>Repository:</b>
{esc(REPO_URL)}
""".strip()

            subprocess.run([
              "curl", "-s", "-X", "POST",
              f"https://api.telegram.org/bot{BOT}/sendMessage",
              "-d", f"chat_id={CHAT}",
              "-d", "parse_mode=HTML",
              "-d", "disable_web_page_preview=true",
              "-d", f"text={message}"
            ])
          PY
