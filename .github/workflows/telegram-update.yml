name: Telegram app updates

on:
  push:
    paths:
      - "**/*.json"

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Create Python script
        run: |
          cat > notify.py <<'PY'
          import json, subprocess, html, os, sys

          BOT = os.environ.get("TELEGRAM_BOT_TOKEN")
          CHAT = os.environ.get("TELEGRAM_CHAT_ID")
          REPO_URL = os.environ.get("REPO_URL", "")

          if not BOT or not CHAT:
              print("Missing Telegram secrets")
              sys.exit(1)

          try:
              file = subprocess.check_output(
                  ["bash", "-lc", "git diff --name-only HEAD^ HEAD | grep '\\.json$' | head -n 1"],
                  text=True
              ).strip()
          except subprocess.CalledProcessError:
              sys.exit(0)

          if not file:
              sys.exit(0)

          def load(path):
              with open(path, "r", encoding="utf-8") as f:
                  return json.load(f)

          def load_prev(path):
              try:
                  data = subprocess.check_output(
                      ["bash", "-lc", f"git show HEAD^:{path}"], text=True
                  )
                  return json.loads(data)
              except:
                  return {"apps": []}

          cur = load(file)
          prev = load_prev(file)

          cur_apps = {a["bundleIdentifier"]: a for a in cur.get("apps", [])}
          prev_apps = {a["bundleIdentifier"]: a for a in prev.get("apps", [])}

          new_apps = [cur_apps[b] for b in cur_apps if b not in prev_apps]

          if not new_apps:
              print("No new apps detected")
              sys.exit(0)

          def latest_version(app):
              versions = app.get("versions", [])
              return max(versions, key=lambda v: v.get("date", "")) if versions else {}

          def esc(s):
              return html.escape(str(s), quote=False)

          for app in new_apps:
              bid = app["bundleIdentifier"]
              ver = latest_version(app)

              msg = f"""
ğŸš€ <b>New App Added to KravaSigner!</b>

ğŸ“± <b>App name:</b> {esc(app.get("name"))}
ğŸ†” <b>Bundle ID:</b> <code>{esc(bid)}</code>
ğŸ‘¨â€ğŸ’» <b>Developer:</b> {esc(app.get("developerName"))}
ğŸ§© <b>Version:</b> {esc(ver.get("version", "N/A"))}

ğŸ“ <b>Description:</b>
{esc(app.get("localizedDescription") or app.get("subtitle") or "")}

ğŸ <b>App Store:</b>
https://apps.apple.com/app/id{app.get("marketplaceID")}

ğŸ“¦ <b>Repository:</b>
{esc(REPO_URL)}
""".strip()

              subprocess.run([
                  "curl", "-s", "-X", "POST",
                  f"https://api.telegram.org/bot{BOT}/sendMessage",
                  "-d", f"chat_id={CHAT}",
                  "-d", "parse_mode=HTML",
                  "-d", "disable_web_page_preview=true",
                  "-d", f"text={msg}"
              ])
          PY

      - name: Run notifier
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          REPO_URL: ${{ secrets.REPO_URL }}
        run: |
          python3 notify.py
