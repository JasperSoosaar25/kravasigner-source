name: KravaSigner New App Poster

on:
  push:
    branches: [ main ]
    paths:
      - 'My-KravaSigner-Working-Source_3.json'

jobs:
  post-to-telegram:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Checkout previous version of JSON
        run: |
          git checkout HEAD~1 -- My-KravaSigner-Working-Source_3.json || touch old.json
          cp My-KravaSigner-Working-Source_3.json new.json || echo "{}" > new.json
          echo "{}" > old.json  # Fallback if no previous

      - name: Parse and Post New Apps
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHANNEL_ID: ${{ secrets.CHANNEL_ID }}
        run: |
          python - << 'PY'
          import json
          import requests
          import os
          import sys

          def load_json(file_path):
              try:
                  with open(file_path, 'r', encoding='utf-8') as f:
                      return json.load(f)
              except Exception as e:
                  print(f"Error loading {file_path}: {e}")
                  return {"apps": []}

          old_data = load_json('old.json')
          new_data = load_json('new.json')

          old_bundles = {app.get('bundleIdentifier', '') for app in old_data.get('apps', [])}
          new_apps = new_data.get('apps', [])

          new_entries = []
          for app in new_apps:
              bundle = app.get('bundleIdentifier')
              if bundle and bundle not in old_bundles:
                  new_entries.append(app)

          if not new_entries:
              print("No new apps detected. Skipping post.")
              sys.exit(0)

          print(f"Found {len(new_entries)} new app(s)! Posting to Telegram...")

          # Headers to bypass Imgur anti-hotlink/bot protection
          headers = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0 Safari/537.36',
              'Referer': 'https://imgur.com/',
              'Accept': 'image/avif,image/webp,image/apng,image/svg+xml,image/*,*/*;q=0.8'
          }

          for app in new_entries:
              name = app.get('name', 'Unknown')
              bundle = app.get('bundleIdentifier', 'Unknown')
              dev = app.get('developerName', 'Unknown')
              subtitle = app.get('subtitle', '')
              desc = app.get('localizedDescription', 'No description')
              versions = app.get('versions', [])
              version = versions[0].get('version', 'Unknown') if versions else 'Unknown'
              app_store_id = app.get('marketplaceID', '')
              icon_url = app.get('iconURL', 'https://i.imgur.com/DMZZBwR.png')  # Fallback to your cute cow

              message = f"<b>üêÆ New App Added to KravaSigner! üêÆ</b>\n\n" \
                        f"<b>Name:</b> {name}\n" \
                        f"<b>Bundle ID:</b> <code>{bundle}</code>\n" \
                        f"<b>Developer:</b> {dev}\n" \
                        f"<b>Subtitle:</b> {subtitle}\n" \
                        f"<b>Version:</b> {version}\n" \
                        f"<b>App Store:</b> https://apps.apple.com/app/id{app_store_id}\n\n" \
                        f"<b>Description:</b>\n{desc}"

              # Try sendPhoto with direct URL (now works with headers!)
              try:
                  response = requests.post(
                      f"https://api.telegram.org/bot{os.environ['BOT_TOKEN']}/sendPhoto",
                      data={
                          'chat_id': os.environ['CHANNEL_ID'],
                          'photo': icon_url,
                          'caption': message,
                          'parse_mode': 'HTML'
                      },
                      headers=headers  # Pass headers so Telegram fetches the image properly
                  )

                  if response.status_code == 200:
                      print(f"Successfully posted {name} with photo!")
                      continue  # Success!

                  print(f"sendPhoto failed ({response.status_code}): {response.text}")
              except Exception as e:
                  print(f"Error with sendPhoto: {e}")

              # Fallback: Download icon ourselves and send as photo (uploaded)
              try:
                  icon_response = requests.get(icon_url, headers=headers, timeout=15)
                  icon_response.raise_for_status()
                  if 'text/html' in icon_response.headers.get('Content-Type', ''):
                      raise Exception("HTML error page")
                  icon_content = icon_response.content

                  files = {'photo': ('icon.png', icon_content, 'image/png')}
                  response = requests.post(
                      f"https://api.telegram.org/bot{os.environ['BOT_TOKEN']}/sendPhoto",
                      data={
                          'chat_id': os.environ['CHANNEL_ID'],
                          'caption': message,
                          'parse_mode': 'HTML'
                      },
                      files=files
                  )

                  if response.status_code == 200:
                      print(f"Successfully posted {name} with uploaded photo fallback!")
                  else:
                      print(f"Fallback failed: {response.text}")
                      sys.exit(1)
              except Exception as e:
                  print(f"Total failure for {name}: {e}")
                  # Last resort: text only
                  requests.post(
                      f"https://api.telegram.org/bot{os.environ['BOT_TOKEN']}/sendMessage",
                      data={
                          'chat_id': os.environ['CHANNEL_ID'],
                          'text': message + "\n\n(Icon failed to load ü•∫)",
                          'parse_mode': 'HTML'
                      }
                  )

          PY
