name: KravaSigner New App Poster

on:
  push:
    branches: [ main ]
    paths:
      - 'My-KravaSigner-Working-Source_3.json'

jobs:
  post-to-telegram:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Checkout previous version of JSON
        run: |
          git checkout HEAD~1 -- My-KravaSigner-Working-Source_3.json || touch old.json
          cp My-KravaSigner-Working-Source_3.json new.json || echo "{}" > new.json
          echo "{}" > old.json  # Safe fallback

      - name: Parse and Post New Apps
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHANNEL_ID: ${{ secrets.CHANNEL_ID }}
        run: |
          python - << 'PY'
          import json
          import requests
          import os
          import sys
          import urllib.parse

          def safe_load_json(file_path):
              try:
                  with open(file_path, 'r', encoding='utf-8') as f:
                      return json.load(f)
              except json.JSONDecodeError as e:
                  print(f"Invalid JSON in {file_path}: {e}")
                  return {"apps": []}
              except Exception as e:
                  print(f"Error reading {file_path}: {e}")
                  return {"apps": []}

          old_data = safe_load_json('old.json')
          new_data = safe_load_json('new.json')

          old_bundles = {app.get('bundleIdentifier', '') for app in old_data.get('apps', []) if app.get('bundleIdentifier')}
          new_apps = new_data.get('apps', [])

          new_entries = []
          for app in new_apps:
              bundle = app.get('bundleIdentifier')
              if bundle and bundle not in old_bundles and app.get('versions'):  # Extra check for valid app
                  new_entries.append(app)

          if not new_entries:
              print("No valid new apps detected. Skipping post.")
              sys.exit(0)

          print(f"Found {len(new_entries)} valid new app(s)! Posting...")

          # Exact URL you want
          raw_url = "https://raw.githubusercontent.com/JasperSoosaar25/kravasigner-source/main/My-KravaSigner-Working-Source_3.json"
          encoded_url = urllib.parse.quote(raw_url, safe='')
          add_repo_url = f"altstore://source?url={encoded_url}"

          headers = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
              'Referer': 'https://imgur.com/'
          }

          for app in new_entries:
              name = app.get('name', 'Unknown')
              bundle = app.get('bundleIdentifier', 'Unknown')
              dev = app.get('developerName', 'Unknown')
              subtitle = app.get('subtitle', '')
              desc = app.get('localizedDescription', 'No description')
              version = app['versions'][0].get('version', 'Unknown') if app.get('versions') else 'Unknown'
              app_store_id = app.get('marketplaceID', '')
              icon_url = app.get('iconURL', 'https://i.imgur.com/DMZZBwR.png')

              message = f"<b>üêÆ New App Added to My KravaSigner Repo!:3 üêÆ</b>\n\n" \
                        f"<b>Name:</b> {name}\n" \
                        f"<b>Bundle ID:</b> <code>{bundle}</code>\n" \
                        f"<b>Developer:</b> {dev}\n" \
                        f"<b>Subtitle:</b> {subtitle}\n" \
                        f"<b>Version:</b> {version}\n" \
                        f"<b>App Store:</b> https://apps.apple.com/app/id{app_store_id}\n\n" \
                        f"<b>Description:</b>\n{desc}\n\n" \
                        f"<b>Add this repo to KravaSigner / Scarlet / Esign etc.:</b>\n" \
                        f"<code>{add_repo_url}</code>"

              # Download and upload icon directly
              try:
                  icon_resp = requests.get(icon_url, headers=headers, timeout=15)
                  icon_resp.raise_for_status()
                  if 'text/html' in icon_resp.headers.get('Content-Type', ''):
                      raise Exception("HTML page received")
                  icon_bytes = icon_resp.content
              except Exception as e:
                  print(f"Icon failed ({icon_url}): {e}")
                  requests.post(
                      f"https://api.telegram.org/bot{os.environ['BOT_TOKEN']}/sendMessage",
                      data={'chat_id': os.environ['CHANNEL_ID'], 'text': message + "\n\n(Icon unavailable ü•∫)", 'parse_mode': 'HTML'}
                  )
                  continue

              files = {'photo': ('icon.png', icon_bytes, 'image/png')}
              response = requests.post(
                  f"https://api.telegram.org/bot{os.environ['BOT_TOKEN']}/sendPhoto",
                  data={'chat_id': os.environ['CHANNEL_ID'], 'caption': message, 'parse_mode': 'HTML'},
                  files=files
              )

              if response.status_code == 200:
                  print(f"Posted {name} successfully!")
              else:
                  print(f"Telegram error: {response.text}")

          PY
