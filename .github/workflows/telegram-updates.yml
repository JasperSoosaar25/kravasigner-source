name: KravaSigner New App Update

on:
  push:
    branches: [ main ]  # Change if your branch is different
    paths:
      - '**/*.json'  # Adjust if needed, e.g. 'source.json'

jobs:
  notify-telegram:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # To access previous commit

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Detect and notify new/updated apps
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # Set your JSON file path here (e.g., 'source.json' or 'apps.json' â€“ check your repo)
          JSON_FILE="source.json"  # <<< CHANGE THIS TO YOUR ACTUAL FILE NAME!!!

          if ! git diff --quiet HEAD~1 HEAD -- "$JSON_FILE"; then
            echo "No changes in $JSON_FILE, skipping."
            exit 0
          fi

          # Get previous and current JSON
          git show HEAD~1:"$JSON_FILE" > old.json || echo "{}" > old.json
          cp "$JSON_FILE" new.json

          # Extract changed bundle IDs (new or modified apps)
          OLD_BUNDLES=$(jq -r '.apps[].bundleIdentifier' old.json | sort | tr '\n' ' ')
          NEW_BUNDLES=$(jq -r '.apps[].bundleIdentifier' new.json | sort | tr '\n' ' ')

          CHANGES=$(comm -13 <(echo "$OLD_BUNDLES") <(echo "$NEW_BUNDLES") | tr -d ' ')

          if [ -z "$CHANGES" ]; then
            echo "No new or significantly updated apps detected."
            exit 0
          fi

          MESSAGE="ðŸ†• *New/Updated App(s) in KravaSigner!*\n\n"

          for bundle in $CHANGES; do
            APP=$(jq -r --arg b "$bundle" '.apps[] | select(.bundleIdentifier == $b)' new.json)

            NAME=$(echo "$APP" | jq -r '.name')
            SUBTITLE=$(echo "$APP" | jq -r '.subtitle // "No subtitle"')
            DEVELOPER=$(echo "$APP" | jq -r '.developerName')
            DESC=$(echo "$APP" | jq -r '.localizedDescription' | head -c 300)
            [ "$(echo "$DESC" | wc -c)" -eq 300 ] && DESC="${DESC}..."
            VERSION=$(echo "$APP" | jq -r '.versions[-1].version')
            MARKET_ID=$(echo "$APP" | jq -r '.marketplaceID')

            MESSAGE="${MESSAGE}*${NAME}*\n"
            MESSAGE="${MESSAGE}Subtitle: ${SUBTITLE}\n"
            MESSAGE="${MESSAGE}Bundle Identifier: \`${bundle}\`\n"
            MESSAGE="${MESSAGE}Marketplace ID: ${MARKET_ID}\n"
            MESSAGE="${MESSAGE}Developer: ${DEVELOPER}\n"
            MESSAGE="${MESSAGE}Version: ${VERSION}\n"
            MESSAGE="${MESSAGE}Description: ${DESC}\n\n"
            MESSAGE="${MESSAGE}[View in Repo](https://github.com/YOURUSERNAME/YOURREPO) ðŸš€\n\n"  # Optional link
          done

          # Send message
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="${MESSAGE}" \
            -d parse_mode="Markdown" \
            -d disable_web_page_preview=true

          echo "Notification sent successfully!"
