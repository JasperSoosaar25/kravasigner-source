name: KravaSigner New App Update

on:
  push:
    branches: [ main ]
    paths:
      - '**.json'

jobs:
  notify-telegram:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Detect and notify new/updated apps
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep '\.json$' || echo "")
          if [ -z "$CHANGED_FILES" ]; then
            echo "No JSON files changed."
            exit 0
          fi

          MESSAGE="ðŸ†• *New or Updated App in KravaSigner!*\n\n"

          HAS_CHANGES=false

          for JSON_FILE in $CHANGED_FILES; do
            echo "Checking $JSON_FILE for app changes..."

            # Get old and new JSON
            git show HEAD~1:"$JSON_FILE" > old.json 2>/dev/null || echo "{}" > old.json
            cp "$JSON_FILE" new.json

            # Extract all apps as "bundleID: json_string"
            jq -r '.apps[]? | "\(.bundleIdentifier):\(tojson)"' old.json > old_apps.txt || touch old_apps.txt
            jq -r '.apps[]? | "\(.bundleIdentifier):\(tojson)"' new.json > new_apps.txt

            # New apps (in new but not old)
            NEW_BUNDLES=$(comm -13 old_apps.txt new_apps.txt | cut -d: -f1)

            # Existing apps that changed
            UPDATED_BUNDLES=""
            for bundle in $(jq -r '.apps[].bundleIdentifier // empty' new.json); do
              OLD_APP=$(grep "^$bundle:" old_apps.txt | cut -d: -f2- || echo "")
              NEW_APP=$(grep "^$bundle:" new_apps.txt | cut -d: -f2-)
              if [ "$OLD_APP" != "$NEW_APP" ]; then
                UPDATED_BUNDLES="$UPDATED_BUNDLES $bundle"
              fi
            done

            ALL_CHANGED="$NEW_BUNDLES$UPDATED_BUNDLES"

            if [ -n "$ALL_CHANGED" ]; then
              HAS_CHANGES=true
              for bundle in $ALL_CHANGED; do
                APP_JSON=$(grep "^$bundle:" new_apps.txt | cut -d: -f2-)
                NAME=$(echo "$APP_JSON" | jq -r '.name')
                ICON=$(echo "$APP_JSON" | jq -r '.iconURL // empty')
                SUBTITLE=$(echo "$APP_JSON" | jq -r '.subtitle // "No subtitle"')
                DEVELOPER=$(echo "$APP_JSON" | jq -r '.developerName')
                DESC=$(echo "$APP_JSON" | jq -r '.localizedDescription // "No description"' | sed 's/"/\\"/g' | cut -c1-400)
                [ ${#DESC} -ge 400 ] && DESC="${DESC}..."
                VERSION=$(echo "$APP_JSON" | jq -r '.versions[-1].version // "Unknown"')
                MARKET_ID=$(echo "$APP_JSON" | jq -r '.marketplaceID // "N/A"')

                MESSAGE="${MESSAGE}${ICON} *${NAME}*\n"
                MESSAGE="${MESSAGE}_Subtitle:_ ${SUBTITLE}\n"
                MESSAGE="${MESSAGE}_Bundle ID:_ \`${bundle}\`\n"
                MESSAGE="${MESSAGE}_Developer:_ ${DEVELOPER}\n"
                MESSAGE="${MESSAGE}_Version:_ ${VERSION}\n"
                MESSAGE="${MESSAGE}_App Store:_ https://apps.apple.com/app/id${MARKET_ID}\n"
                MESSAGE="${MESSAGE}_Description:_ ${DESC}\n\n"
              done
            fi
          done

          if $HAS_CHANGES; then
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d text="${MESSAGE}" \
              -d parse_mode="Markdown" \
              -d disable_web_page_preview=false  # false so icon previews
            echo "Full notification sent!"
          else
            echo "JSON changed but no new/updated apps detected â€” no notification sent."
          fi
