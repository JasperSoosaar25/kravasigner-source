name: KravaSigner New App Poster

on:
  push:
    branches: [ main ]
    paths:
      - 'My-KravaSigner-Working-Source_3.json'

jobs:
  post-to-telegram:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Checkout previous version of JSON
        run: |
          git checkout HEAD~1 -- My-KravaSigner-Working-Source_3.json || touch old.json
          cp My-KravaSigner-Working-Source_3.json new.json || echo "{}" > new.json
          echo "{}" > old.json

      - name: Parse and Post New Apps
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHANNEL_ID: ${{ secrets.CHANNEL_ID }}
        run: |
          python - << 'PY'
          import json
          import requests
          import os
          import sys

          def load_json(file_path):
              try:
                  with open(file_path, 'r', encoding='utf-8') as f:
                      return json.load(f)
              except Exception as e:
                  print(f"Error loading {file_path}: {e}")
                  return {"apps": []}

          old_data = load_json('old.json')
          new_data = load_json('new.json')

          old_bundles = {app.get('bundleIdentifier', '') for app in old_data.get('apps', [])}
          new_apps = new_data.get('apps', [])

          new_entries = [app for app in new_apps if app.get('bundleIdentifier') not in old_bundles]

          if not new_entries:
              print("No new apps detected. Skipping post.")
              sys.exit(0)

          print(f"Found {len(new_entries)} new app(s)!")

          headers = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
              'Referer': 'https://imgur.com/'
          }

          for app in new_entries:
              name = app.get('name', 'Unknown')
              bundle = app.get('bundleIdentifier', 'Unknown')
              dev = app.get('developerName', 'Unknown')
              subtitle = app.get('subtitle', '')
              desc = app.get('localizedDescription', 'No description')
              version = app['versions'][0].get('version', 'Unknown') if app.get('versions') else 'Unknown'
              app_store_id = app.get('marketplaceID', '')
              icon_url = app.get('iconURL', 'https://i.imgur.com/DMZZBwR.png')

              message = f"<b>üêÆ New App Added to KravaSigner! üêÆ</b>\n\n" \
                        f"<b>Name:</b> {name}\n" \
                        f"<b>Bundle ID:</b> <code>{bundle}</code>\n" \
                        f"<b>Developer:</b> {dev}\n" \
                        f"<b>Subtitle:</b> {subtitle}\n" \
                        f"<b>Version:</b> {version}\n" \
                        f"<b>App Store:</b> https://apps.apple.com/app/id{app_store_id}\n\n" \
                        f"<b>Description:</b>\n{desc}"

              # Download icon binary
              try:
                  icon_resp = requests.get(icon_url, headers=headers, timeout=15)
                  icon_resp.raise_for_status()
                  if 'text/html' in icon_resp.headers.get('Content-Type', ''):
                      raise Exception("HTML error page")
                  icon_bytes = icon_resp.content
                  icon_filename = "icon.png"
              except Exception as e:
                  print(f"Icon download failed: {e}")
                  # Fallback text-only
                  requests.post(
                      f"https://api.telegram.org/bot{os.environ['BOT_TOKEN']}/sendMessage",
                      data={'chat_id': os.environ['CHANNEL_ID'], 'text': message + "\n\n(Icon unavailable ü•∫)", 'parse_mode': 'HTML'}
                  )
                  continue

              # Upload as photo data ‚Üí bypasses geoblock!
              files = {'photo': (icon_filename, icon_bytes, 'image/png')}
              response = requests.post(
                  f"https://api.telegram.org/bot{os.environ['BOT_TOKEN']}/sendPhoto",
                  data={'chat_id': os.environ['CHANNEL_ID'], 'caption': message, 'parse_mode': 'HTML'},
                  files=files
              )

              if response.status_code == 200:
                  print(f"Posted {name} with uploaded icon!")
              else:
                  print(f"Error: {response.text}")

          PY
