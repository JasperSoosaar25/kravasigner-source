name: KravaSigner New App Update

on:
  push:
    branches: [ main ]
    paths:
      - '**.json'

jobs:
  notify-telegram:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Detect and notify each changed app
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep '\.json$' || echo "")
          if [ -z "$CHANGED_FILES" ]; then
            echo "No JSON files changed."
            exit 0
          fi

          for JSON_FILE in $CHANGED_FILES; do
            echo "Processing $JSON_FILE"

            git show HEAD~1:"$JSON_FILE" > old.json 2>/dev/null || echo '{"apps":[]}' > old.json
            cp "$JSON_FILE" new.json

            jq -S -c '.apps[]? | {bundle: .bundleIdentifier, app: .}' old.json | jq -r '"\(.bundle):\(.app | tojson)"' > old_apps.txt || touch old_apps.txt
            jq -S -c '.apps[]? | {bundle: .bundleIdentifier, app: .}' new.json | jq -r '"\(.bundle):\(.app | tojson)"' > new_apps.txt

            ALL_NEW_BUNDLES=$(cut -d: -f1 new_apps.txt | sort -u)

            for bundle in $ALL_NEW_BUNDLES; do
              OLD_LINE=$(grep "^$bundle:" old_apps.txt || echo "")
              NEW_LINE=$(grep "^$bundle:" new_apps.txt)

              if [ -z "$OLD_LINE" ]; then
                CHANGE_TYPE="NEW"
              elif [ "$OLD_LINE" = "$NEW_LINE" ]; then
                continue
              else
                CHANGE_TYPE="UPDATED"
              fi

              APP_JSON=$(echo "$NEW_LINE" | cut -d: -f2-)

              NAME=$(echo "$APP_JSON" | jq -r '.name')
              ICON=$(echo "$APP_JSON" | jq -r '.iconURL // ""')
              SUBTITLE=$(echo "$APP_JSON" | jq -r '.subtitle // "No subtitle"')
              DEVELOPER=$(echo "$APP_JSON" | jq -r '.developerName // "Unknown"')
              DESC=$(echo "$APP_JSON" | jq -r '.localizedDescription // "No description"' | sed 's/"/\\"/g' | cut -c1-500)
              [ ${#DESC} -eq 500 ] && DESC="${DESC}..."
              VERSION=$(echo "$APP_JSON" | jq -r '.versions[-1].version // "Unknown"')
              MARKET_ID=$(echo "$APP_JSON" | jq -r '.marketplaceID // ""')

              ESC() { echo "$1" | sed -e 's/[*_`[\]\\]/\\&/g'; }
              ESC_NAME=$(ESC "$NAME")
              ESC_SUB=$(ESC "$SUBTITLE")
              ESC_DEV=$(ESC "$DEVELOPER")
              ESC_DESC=$(ESC "$DESC")

              MESSAGE="ðŸ†• *$CHANGE_TYPE APP IN KRAVASIGNER!*\n\n"
              MESSAGE+="${ICON} *${ESC_NAME}*\n\n"
              MESSAGE+="_Subtitle:_ ${ESC_SUB}\n"
              MESSAGE+="_Bundle ID:_ \`${bundle}\`\n"
              MESSAGE+="_Developer:_ ${ESC_DEV}\n"
              MESSAGE+="_Latest Version:_ ${VERSION}\n"
              if [ -n "$MARKET_ID" ]; then
                MESSAGE+="_App Store:_ https://apps.apple.com/app/id${MARKET_ID}\n"
              fi
              MESSAGE+="_Description:_ ${ESC_DESC}"

              # Send and capture response
              RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
                -d chat_id="${TELEGRAM_CHAT_ID}" \
                -d text="${MESSAGE}" \
                -d parse_mode="Markdown" \
                -d disable_web_page_preview=false)

              echo "Telegram API Response for $NAME:"
              echo "$RESPONSE"

              if echo "$RESPONSE" | grep -q '"ok":true'; then
                echo "Message sent successfully for $NAME!"
              else
                echo "Failed to send message for $NAME. Check error above."
              fi
            done
          done

          echo "Workflow complete."
