name: KravaSigner New App Update

on:
  push:
    branches: [ main ]  # Change if your default branch is different
    paths:
      - '**.json'  # Only run if the JSON file changes (adjust path if needed, e.g. 'apps.json')

jobs:
  notify-telegram:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Needed to compare with previous commit

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Detect changed apps and notify
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # Install jq for JSON parsing
          sudo apt-get update && sudo apt-get install -y jq

          # Get the JSON file name (assuming it's the only .json or name it explicitly)
          JSON_FILE=$(git diff --name-only HEAD~1 HEAD | grep '.json$' | head -1)
          if [ -z "$JSON_FILE" ]; then
            echo "No JSON file changed, skipping."
            exit 0
          fi

          # Get previous and current versions of the file
          git checkout HEAD~1 -- "$JSON_FILE" -q
          cp "$JSON_FILE" old.json
          git checkout HEAD -- "$JSON_FILE" -q

          # Extract apps as bundleID keys for easy comparison
          jq -c '.apps[] | {(.bundleIdentifier): .}' old.json > old_apps.json
          jq -c '.apps[] | {(.bundleIdentifier): .}' "$JSON_FILE" > new_apps.json

          # Find new or updated apps
          CHANGES=$(comm -13 <(jq -r 'keys[]' old_apps.json | sort) <(jq -r 'keys[]' new_apps.json | sort))
          if [ -z "$CHANGES" ]; then
            echo "No new or updated apps detected."
            exit 0
          fi

          # Build message for each changed app
          MESSAGE="ðŸ†• *New/Updated App in KravaSigner!*\n\n"
          for bundle in $CHANGES; do
            APP=$(jq -r ".[\"$bundle\"]" new_apps.json)
            NAME=$(echo "$APP" | jq -r '.name')
            SUBTITLE=$(echo "$APP" | jq -r '.subtitle')
            DEVELOPER=$(echo "$APP" | jq -r '.developerName')
            DESC=$(echo "$APP" | jq -r '.localizedDescription' | head -c 300)  # Truncate long desc
            VERSION=$(echo "$APP" | jq -r '.versions[-1].version')  # Latest version
            MARKET_ID=$(echo "$APP" | jq -r '.marketplaceID')

            MESSAGE="${MESSAGE}*${NAME}*\n"
            MESSAGE="${MESSAGE}Subtitle: ${SUBTITLE}\n"
            MESSAGE="${MESSAGE}Bundle ID: \`${bundle}\`\n"
            MESSAGE="${MESSAGE}App Store ID: ${MARKET_ID}\n"
            MESSAGE="${MESSAGE}Developer: ${DEVELOPER}\n"
            MESSAGE="${MESSAGE}Version: ${VERSION}\n"
            MESSAGE="${MESSAGE}Description: ${DESC}...\n\n"
          done

          # Send to Telegram (with Markdown formatting)
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="${MESSAGE}" \
            -d parse_mode="Markdown" \
            -d disable_web_page_preview=true

          echo "Notification sent!"
