name: KravaSigner New App Poster

on:
  push:
    branches: [ main ]
    paths:
      - 'My-KravaSigner-Working-Source_3.json'

jobs:
  post-to-telegram:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Checkout previous version of JSON
        run: |
          git checkout HEAD~1 -- My-KravaSigner-Working-Source_3.json || touch old.json
          cp My-KravaSigner-Working-Source_3.json new.json || echo "{}" > new.json
          echo "{}" > old.json  # Fallback if no previous

      - name: Parse and Post New Apps
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHANNEL_ID: ${{ secrets.CHANNEL_ID }}
        run: |
          python - << 'PY'
          import json
          import requests
          import os
          import sys

          def load_json(file_path):
              try:
                  with open(file_path, 'r', encoding='utf-8') as f:
                      return json.load(f)
              except Exception as e:
                  print(f"Error loading {file_path}: {e}")
                  return {"apps": []}

          old_data = load_json('old.json')
          new_data = load_json('new.json')

          old_bundles = {app.get('bundleIdentifier', '') for app in old_data.get('apps', [])}
          new_apps = new_data.get('apps', [])

          new_entries = []
          for app in new_apps:
              bundle = app.get('bundleIdentifier')
              if bundle and bundle not in old_bundles:
                  new_entries.append(app)

          if not new_entries:
              print("No new apps detected. Skipping post.")
              sys.exit(0)

          print(f"Found {len(new_entries)} new app(s)! Posting to Telegram...")

          for app in new_entries:
              name = app.get('name', 'Unknown')
              bundle = app.get('bundleIdentifier', 'Unknown')
              dev = app.get('developerName', 'Unknown')
              subtitle = app.get('subtitle', '')
              desc = app.get('localizedDescription', 'No description')
              versions = app.get('versions', [])
              version = versions[0].get('version', 'Unknown') if versions else 'Unknown'
              app_store_id = app.get('marketplaceID', '')
              icon = app.get('iconURL', 'https://i.imgur.com/DMZZBwR.png')  # Fallback to your cow icon

              message = f"<b>üêÆ New App Added to KravaSigner! üêÆ</b>\n\n" \
                        f"<b>Name:</b> {name}\n" \
                        f"<b>Bundle ID:</b> <code>{bundle}</code>\n" \
                        f"<b>Developer:</b> {dev}\n" \
                        f"<b>Subtitle:</b> {subtitle}\n" \
                        f"<b>Version:</b> {version}\n" \
                        f"<b>App Store:</b> https://apps.apple.com/app/id{app_store_id}\n\n" \
                        f"<b>Description:</b>\n{desc}"

              response = requests.post(
                  f"https://api.telegram.org/bot{os.environ['BOT_TOKEN']}/sendPhoto",
                  data={
                      'chat_id': os.environ['CHANNEL_ID'],
                      'photo': icon,
                      'caption': message,
                      'parse_mode': 'HTML'
                  }
              )

              if response.status_code == 200:
                  print(f"Successfully posted {name}!")
              else:
                  print(f"Error posting {name}: {response.text}")
                  sys.exit(1)  # Fail workflow if Telegram error

          PY
